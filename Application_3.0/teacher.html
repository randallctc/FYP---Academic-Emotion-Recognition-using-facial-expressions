<!DOCTYPE html>
<html>
<head>
    <title>Teacher Dashboard - Classroom Emotion Monitor</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .header h1 { margin-bottom: 10px; }
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
        }
        .btn-primary { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn:disabled { background: #95a5a6; cursor: not-allowed; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .emotion-bar {
            margin-bottom: 15px;
        }
        .emotion-bar-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .emotion-bar-fill {
            height: 25px;
            border-radius: 4px;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            padding-left: 10px;
            color: white;
            font-weight: bold;
        }
        
        .color-engagement { background: #27ae60; }
        .color-boredom { background: #95a5a6; }
        .color-confusion { background: #f39c12; }
        .color-frustration { background: #e74c3c; }
        
        #alerts {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .alert {
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 4px;
            background: #fff3cd;
            border-left: 4px solid #f39c12;
        }
        .alert-danger {
            background: #f8d7da;
            border-left-color: #e74c3c;
        }
        
        #student-list {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .student-item {
            padding: 10px;
            border-bottom: 1px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .student-emotion {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        
        .status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
        }
        .status-recording {
            background: #e74c3c;
            color: white;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .status-stopped {
            background: #95a5a6;
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéì Teacher Dashboard</h1>
        <p>Monitor student emotions in real-time</p>
    </div>
    
    <div class="controls">
        <button id="startBtn" class="btn btn-primary" onclick="startRecording()">
            ‚ñ∂ Start Recording
        </button>
        <button id="stopBtn" class="btn btn-danger" onclick="stopRecording()" disabled>
            ‚èπ Stop Recording
        </button>
        <span id="status" class="status status-stopped">Not Recording</span>
        <span id="timer" style="margin-left: 20px; font-size: 18px; font-weight: bold;">00:00</span>
    </div>
    
    <div class="stats-grid">
        <div class="stat-card">
            <h3>üìä Current Emotions</h3>
            <div id="emotion-bars">
                <p style="color: #95a5a6;">Waiting for students to join...</p>
            </div>
        </div>
        
        <div class="stat-card">
            <h3>üë• Students Connected</h3>
            <div id="student-count" style="font-size: 48px; text-align: center; color: #3498db; margin: 20px 0;">
                0
            </div>
        </div>
    </div>
    
    <div id="alerts" style="display: none;">
        <h3>‚ö†Ô∏è Alerts</h3>
        <div id="alert-list"></div>
    </div>
    
    <div id="student-list">
        <h3>üë• Student List</h3>
        <div id="students"></div>
    </div>

    <script>
        const socket = io();
        let isRecording = false;
        let startTime = null;
        let timerInterval = null;
        
        socket.on('connect', () => {
            console.log('Connected to server');
        });
        
        socket.on('student_list_update', (data) => {
            updateStudentList(data);
        });
        
        socket.on('classroom_update', (data) => {
            updateEmotionBars(data);
            
            if (data.alert) {
                addAlert(data.alert, data.timestamp);
            }
        });
        
        socket.on('recording_started', (data) => {
            console.log('Recording started:', data.session_id);
        });
        
        socket.on('recording_stopped', (data) => {
            console.log('Recording stopped, file:', data.file);
            alert('Recording saved! Check classroom_sessions folder.');
        });
        
        function startRecording() {
            fetch('/start_recording', {method: 'POST'})
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        isRecording = true;
                        startTime = Date.now();
                        
                        document.getElementById('startBtn').disabled = true;
                        document.getElementById('stopBtn').disabled = false;
                        document.getElementById('status').className = 'status status-recording';
                        document.getElementById('status').textContent = 'üî¥ Recording';
                        
                        timerInterval = setInterval(updateTimer, 1000);
                    }
                });
        }
        
        function stopRecording() {
            fetch('/stop_recording', {method: 'POST'})
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        isRecording = false;
                        
                        document.getElementById('startBtn').disabled = false;
                        document.getElementById('stopBtn').disabled = true;
                        document.getElementById('status').className = 'status status-stopped';
                        document.getElementById('status').textContent = 'Stopped';
                        
                        clearInterval(timerInterval);
                    }
                });
        }
        
        function updateTimer() {
            if (!startTime) return;
            
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            
            document.getElementById('timer').textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        function updateStudentList(data) {
            document.getElementById('student-count').textContent = data.count;
            
            const studentsDiv = document.getElementById('students');
            studentsDiv.innerHTML = '';
            
            if (data.students.length === 0) {
                studentsDiv.innerHTML = '<p style="color: #95a5a6;">No students connected yet</p>';
                return;
            }
            
            data.students.forEach(student => {
                const item = document.createElement('div');
                item.className = 'student-item';
                
                const emotion = student.current_emotion ? student.current_emotion.emotion : 'Waiting...';
                const confidence = student.current_emotion ? 
                    (student.current_emotion.confidence * 100).toFixed(0) + '%' : '';
                
                item.innerHTML = `
                    <span><strong>${student.name}</strong></span>
                    <span class="student-emotion color-${emotion.toLowerCase()}">${emotion} ${confidence}</span>
                `;
                
                studentsDiv.appendChild(item);
            });
        }
        
        function updateEmotionBars(data) {
            const barsDiv = document.getElementById('emotion-bars');
            barsDiv.innerHTML = '';
            
            const emotions = ['Engagement', 'Boredom', 'Confusion', 'Frustration'];
            
            emotions.forEach(emotion => {
                const count = data.emotions[emotion] || 0;
                const percentage = data.percentages[emotion] || 0;
                
                const barDiv = document.createElement('div');
                barDiv.className = 'emotion-bar';
                barDiv.innerHTML = `
                    <div class="emotion-bar-label">
                        <span>${emotion}</span>
                        <span>${count} students (${percentage.toFixed(1)}%)</span>
                    </div>
                    <div class="emotion-bar-fill color-${emotion.toLowerCase()}" 
                         style="width: ${percentage}%">
                    </div>
                `;
                
                barsDiv.appendChild(barDiv);
            });
        }
        
        function addAlert(message, timestamp) {
            const alertsDiv = document.getElementById('alerts');
            const alertList = document.getElementById('alert-list');
            
            alertsDiv.style.display = 'block';
            
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger';
            alert.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            alertList.insertBefore(alert, alertList.firstChild);
            
            // Keep only last 10 alerts
            while (alertList.children.length > 10) {
                alertList.removeChild(alertList.lastChild);
            }
        }
    </script>
</body>
</html>
